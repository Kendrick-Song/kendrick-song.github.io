# 踩坑记录

## 容器内对挂载文件夹使用 `mv` 命令导致主机对应文件全部被删除 😭

::: danger 时刻牢记

在容器内除被挂载的目录外，其他任何操作（新建/删除/修改）都不会被持久化！

风险操作前一定记得备份！

:::

### 问题描述

起因是我在把博客部署到 Github 上的时候，由于仓库名称和本地项目目录名称不同，导致构建好的静态页面会因为路径问题没有办法在 Github Pages 上正常显示。

解决方法很简单，就是每次部署的时候都需要在 `docs/.vuepress/config.js` 中设置正确的 `base`，具体参考 [部署 | VuePress (vuejs.org)](https://vuepress.vuejs.org/zh/guide/deploy.html#github-pages)。~~部署完成后需要注释掉，否则本地构建会失败。~~**（后来发现不注释掉也可以正常构建，不知道在哪看的文章深深的误导了我 ，不然我也不会踩到后面这个大坑😭）**

每次想部署到 Github 上都要改一下这个配置，感觉很麻烦，我就想「能不能把项目根目录的名字改的和仓库一样，这样就省的每次改配置了」。于是乎我就在容器内用 `mv` 命令将项目根目录名称给改了，结果**容器直接停止运行**。

这时候我还觉得一切还 OK，可能就是不能改吧，`mv` 操作失败，重启容器就好了。一重启发现容器起不来了，查日志提示项目目录下找不到 `package.json` 文件。

那就新开一个容器呗？但是**手贱的我不只新开了一个容器，还把原来的容器给删掉了…**，给后面文档找不回来埋下伏笔。

新开的容器可以跑起来，但是定睛一看：哎？我文档呢？怎么是空的？

这个时候我已经预感不妙：不会刚才 `mv` 操作已经把项目文件给操作了吧？我赶紧回到我宿主机挂载文档的目录看一眼，果不其然，**所有文档全没了…**

### 解决过程

我开始逐一实验排查文档消失前的每一步操作，最终定位到了 `mv` 命令这一步。

为了方便文档同步，查看部署效果，我在启动容器时将容器内的 `docs` 文件夹和宿主机的文档文件夹设置了绑定挂载（bind mounts），使得这两个文件夹的内容是**实时同步**的，这样我就可以在宿主机编写文档，还能时刻查看部署效果。

正常使用都没什么问题，但是当我使用 `mv` 命令对容器内项目根目录更名时，问题出现了。 `mv` 命令对文件夹进行更名实际上大致是以下几个步骤：

1. 创建目标文件夹；
1. 将原文件夹内所有内容复制到目标文件夹；
1. 删除原文件夹及其内容。

**问题就出现在这里！**

虽然 `mv` 命令最终失败了，但是提示的是我挂载的目录被占用了，无法被删除，也就意味着除了这个目录本身以外的内容，全都已经被移动到了目标文件夹中（经过实验测试的确是这样的），而原文件夹只剩下了挂载目录这一个空壳。

所以我们现在来捋一下这个问题发生的过程：

1. 用 `mv` 命令对项目文件夹更名，项目文件夹内有挂载到主机的目录，导致 `mv` 命令报错：无法删除，但除目录外的文件均已移动到新文件夹；
1. **因为宿主机和容器的挂载目录是同步的，所以宿主机对应的内容也被删除了。**
1. 因为项目文件被移走了，导致 VuePress 进程异常退出，容器关闭；

4. **因为容器内的文件操作是不会被持久化的，所以容器删除后那些文档就消失了。**

不幸的是这些文档是肯定找不回来了，不幸中的万幸是在这之前我已经把它们部署到 Github 上了，内容都在，只是得重新搞一下格式。

### 经验总结

- 时刻备份重要文件，尤其是在风险操作之前。
- 同 `rm` 命令类似，`mv` 命令也是一个具有破坏性的命令，如果使用不当，很可能给系统带来灾难性的后果。

